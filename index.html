<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0a">
    <title>Nutrition Tracker</title>

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #ffffff;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: env(safe-area-inset-top, 15px) 15px env(safe-area-inset-bottom, 15px);
            min-height: 100vh;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Status Bar */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            height: 40px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #a0a0a0;
            cursor: pointer;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #fbbf24;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #10b981;
            animation: none;
        }

        .status-dot.error {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sync-info {
            font-size: 10px;
            color: #666;
        }

        .unsynced-badge {
            background: #ef4444;
            color: white;
            border-radius: 8px;
            padding: 1px 5px;
            font-size: 9px;
            font-weight: 600;
            margin-left: 4px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            margin-top: 45px;
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            cursor: pointer;
            user-select: none;
        }

        .date-display {
            font-size: 14px;
            color: #a0a0a0;
            margin-bottom: 15px;
        }

        .card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .daily-totals {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .total-item {
            text-align: center;
        }

        .total-value {
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 4px;
            transition: transform 0.2s ease;
        }

        .total-label {
            font-size: 11px;
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #2a2a2a;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 6px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
        }

        .form-group {
            margin-bottom: 15px;
            position: relative;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #a0a0a0;
            margin-bottom: 6px;
        }

        .form-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .form-input {
            width: 100%;
            min-height: 52px;
            background: #2a2a2a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0 50px 0 16px;
            color: #ffffff;
            font-size: 16px;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
            transform: scale(1.02);
        }

        .input-steppers {
            position: absolute;
            right: 8px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stepper-btn {
            width: 32px;
            height: 22px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 6px;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            user-select: none;
        }

        .stepper-btn:active {
            background: rgba(102, 126, 234, 0.4);
            transform: scale(0.95);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .meal-type-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23a0a0a0' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        .submit-btn {
            width: 100%;
            min-height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 16px;
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .submit-btn.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .success-checkmark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 24px;
            animation: checkmarkPop 0.5s ease forwards;
        }

        @keyframes checkmarkPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .apple-health-options {
            background: rgba(102, 126, 234, 0.05);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }

        .apple-health-options.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .favorite-indicator {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #667eea;
            text-align: center;
            display: none;
        }

        .favorite-indicator.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .apple-health-btn {
            width: 100%;
            min-height: 44px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }

        .apple-health-btn.primary {
            background: rgba(102, 126, 234, 0.15);
        }

        .apple-health-btn:active {
            background: rgba(102, 126, 234, 0.25);
            transform: scale(0.98);
        }

        .undo-btn {
            width: 100%;
            min-height: 44px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            color: #ef4444;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 15px;
            display: none;
        }

        .undo-btn.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .favorites-section {
            margin-bottom: 20px;
        }

        .favorites-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .favorite-btn {
            background: #2a2a2a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 10px;
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-height: 48px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .favorite-btn:active {
            transform: scale(0.95);
            background: #3a3a3a;
        }

        .favorite-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .favorite-macros {
            font-size: 10px;
            color: #a0a0a0;
            line-height: 1.2;
        }

        .delete-favorite {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .favorite-btn:hover .delete-favorite {
            display: flex;
        }

        .add-favorite-btn {
            width: 100%;
            min-height: 44px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px dashed rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 15px;
        }

        .history-section {
            margin-bottom: 20px;
        }

        .history-item {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .history-item:hover {
            background: #3a3a3a;
            border-color: rgba(102, 126, 234, 0.2);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-time {
            font-size: 11px;
            color: #a0a0a0;
        }

        .history-details {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            font-size: 11px;
        }

        .history-macro {
            text-align: center;
        }

        .history-macro-value {
            font-weight: 600;
            color: #ffffff;
        }

        .history-macro-label {
            color: #a0a0a0;
            margin-top: 2px;
        }

        .history-delete {
            position: absolute;
            right: 8px;
            top: 8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .history-item:hover .history-delete {
            opacity: 1;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 50px;
            right: 15px;
            z-index: 2000;
            pointer-events: none;
            max-width: 350px;
        }

        .toast {
            background: #2a2a2a;
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: auto;
            animation: slideInRight 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateX(100%);
        }

        .toast.show {
            transform: translateX(0);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success {
            border-left: 3px solid #10b981;
        }

        .toast.error {
            border-left: 3px solid #ef4444;
        }

        .toast-icon {
            font-size: 16px;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 14px;
        }

        /* Test Panel */
        .test-panel {
            position: fixed;
            bottom: -250px;
            left: 0;
            right: 0;
            background: #1a1a1a;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            transition: bottom 0.3s ease;
            z-index: 3000;
        }

        .test-panel.show {
            bottom: 0;
        }

        .test-btn {
            background: #2a2a2a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .macro-calc {
            font-size: 11px;
            color: #a0a0a0;
            text-align: center;
            margin-top: 8px;
            padding: 8px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .macro-warning {
            color: #fbbf24;
        }

        .pull-to-refresh {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .nutrition-description {
            grid-column: 1 / -1;
        }

        @media (max-width: 480px) {
            .container {
                padding: env(safe-area-inset-top, 10px) 12px env(safe-area-inset-bottom, 10px);
            }

            .toast-container {
                left: 12px;
                right: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="connection-status" onclick="toggleTestPanel()">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Connecting...</span>
            <span class="unsynced-badge" id="unsyncedBadge" style="display: none;">0</span>
        </div>
        <div class="sync-info" id="syncInfo">Real-time sync</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="pull-to-refresh" id="pullToRefresh">‚Üì</div>

    <!-- Test Panel -->
    <div class="test-panel" id="testPanel">
        <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: #667eea;">‚öôÔ∏è Database Controls</div>
        <button class="test-btn" onclick="testConnection()">Test Supabase</button>
        <button class="test-btn" onclick="createTables()">Create Database Tables</button>
        <button class="test-btn" onclick="exportData()">Export Data</button>
        <button class="test-btn" onclick="clearAllData()">Clear All Data</button>
        <button class="test-btn" onclick="migrateFromLocalStorage()">Import from Old System</button>
        <button class="test-btn" onclick="toggleTestPanel()">Close</button>
        <div id="debugInfo" style="margin-top: 10px; font-size: 11px; color: #a0a0a0;"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1 class="app-title" onclick="toggleTestPanel()">Nutrition Tracker</h1>
            <div class="date-display" id="dateDisplay"></div>
        </div>

        <div class="card">
            <div class="daily-totals">
                <div class="total-item">
                    <div class="total-value" id="totalCalories">0</div>
                    <div class="total-label">Calories</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="caloriesProgress"></div>
                    </div>
                </div>
                <div class="total-item">
                    <div class="total-value" id="totalProtein">0g</div>
                    <div class="total-label">Protein</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="proteinProgress"></div>
                    </div>
                </div>
                <div class="total-item">
                    <div class="total-value" id="totalCarbs">0g</div>
                    <div class="total-label">Carbs</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="carbsProgress"></div>
                    </div>
                </div>
                <div class="total-item">
                    <div class="total-value" id="totalFat">0g</div>
                    <div class="total-label">Fat</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="fatProgress"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h2 class="section-title">Add Entry</h2>
            <div class="card">
                <!-- Favorite Indicator -->
                <div class="favorite-indicator" id="favoriteIndicator"></div>

                <form id="nutritionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="calories">Calories</label>
                            <div class="form-input-wrapper">
                                <input type="number" class="form-input" id="calories" name="calories" placeholder="0" min="0" max="5000" inputmode="numeric">
                                <div class="input-steppers">
                                    <button type="button" class="stepper-btn" onclick="stepValue('calories', 50)">+</button>
                                    <button type="button" class="stepper-btn" onclick="stepValue('calories', -50)">-</button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="protein">Protein (g)</label>
                            <div class="form-input-wrapper">
                                <input type="number" class="form-input" id="protein" name="protein" placeholder="0" min="0" max="500" step="0.1" inputmode="decimal">
                                <div class="input-steppers">
                                    <button type="button" class="stepper-btn" onclick="stepValue('protein', 5)">+</button>
                                    <button type="button" class="stepper-btn" onclick="stepValue('protein', -5)">-</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="carbs">Carbs (g)</label>
                            <div class="form-input-wrapper">
                                <input type="number" class="form-input" id="carbs" name="carbs" placeholder="0" min="0" max="500" step="0.1" inputmode="decimal">
                                <div class="input-steppers">
                                    <button type="button" class="stepper-btn" onclick="stepValue('carbs', 5)">+</button>
                                    <button type="button" class="stepper-btn" onclick="stepValue('carbs', -5)">-</button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="fat">Fat (g)</label>
                            <div class="form-input-wrapper">
                                <input type="number" class="form-input" id="fat" name="fat" placeholder="0" min="0" max="500" step="0.1" inputmode="decimal">
                                <div class="input-steppers">
                                    <button type="button" class="stepper-btn" onclick="stepValue('fat', 5)">+</button>
                                    <button type="button" class="stepper-btn" onclick="stepValue('fat', -5)">-</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="mealType">Meal Type</label>
                        <select class="form-input meal-type-select" id="mealType" name="mealType">
                            <option value="Breakfast">Breakfast</option>
                            <option value="Lunch">Lunch</option>
                            <option value="Dinner">Dinner</option>
                            <option value="Snack">Snack</option>
                            <option value="Protein Shake">Protein Shake</option>
                        </select>
                    </div>

                    <div class="form-group nutrition-description">
                        <label class="form-label" for="description">Description (Optional)</label>
                        <input type="text" class="form-input" id="description" name="description" placeholder="e.g., Grilled chicken with vegetables">
                    </div>

                    <div class="macro-calc" id="macroCalc" style="display: none;"></div>

                    <button type="submit" class="submit-btn" id="submitBtn">Log Entry</button>

                    <!-- Apple Health Options -->
                    <div class="apple-health-options" id="appleHealthOptions">
                        <p style="font-size: 12px; color: #a0a0a0; margin-bottom: 10px; text-align: center;">
                            Log to Apple Health:
                        </p>
                        <button type="button" class="apple-health-btn primary" onclick="logToAppleHealth()">
                            üì± Send to Apple Health
                        </button>
                    </div>

                    <!-- Undo Button -->
                    <button type="button" class="undo-btn" id="undoBtn" onclick="undoLastEntry()">
                        ‚Ü∂ Undo Last Entry
                    </button>

                    <!-- Save as Favorite Button -->
                    <button type="button" class="add-favorite-btn" id="addFavoriteBtn" onclick="saveAsFavorite()">
                        ‚≠ê Save as Favorite
                    </button>
                </form>
            </div>
        </div>

        <div class="favorites-section">
            <h2 class="section-title">Favorites</h2>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <select style="flex: 1; background: #2a2a2a; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 12px; color: #ffffff; font-size: 14px;" id="favoritesFilter" onchange="filterFavorites()">
                    <option value="all">All Categories</option>
                    <option value="Breakfast">Breakfast</option>
                    <option value="Lunch">Lunch</option>
                    <option value="Dinner">Dinner</option>
                    <option value="Snack">Snack</option>
                    <option value="Protein Shake">Protein Shake</option>
                </select>
                <input type="text" style="flex: 2; background: #2a2a2a; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 12px; color: #ffffff; font-size: 14px;" id="favoritesSearch" placeholder="Search favorites..." oninput="filterFavorites()">
            </div>

            <div class="favorites-grid" id="favoritesGrid">
                <!-- Favorites will be loaded here -->
            </div>
        </div>

        <div class="history-section">
            <h2 class="section-title">Today's Entries</h2>
            <div id="historyContainer">
                <!-- History will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://hvixlqyldvdzzxxgjxyh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2aXhscXlsZHZkenp4eGdqeHloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNjE3MTUsImV4cCI6MjA3MTgzNzcxNX0.TeNv-BbxR39V3F-EWkf2FaXjs5P29nBmus14MR5TIRw';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Configuration
        const DAILY_GOALS = {
            calories: 2000,
            protein: 150,
            carbs: 200,
            fat: 65
        };

        // Global state
        let dailyTotals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
        let todaysEntries = [];
        let favorites = [];
        let lastEntry = null;
        let currentFavorite = null;
        let isConnected = false;
        let favoriteIndicatorTimeout = null;
        let toastCount = 0;

        // DOM elements
        const $ = (id) => document.getElementById(id);

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing Nutrition Tracker with Supabase...');

            // Check Supabase connection
            await testSupabaseConnection();

            // Load initial data
            await Promise.all([
                loadTodaysTotals(),
                loadTodaysEntries(),
                loadFavorites()
            ]);

            // Setup UI
            updateDateDisplay();
            setupEventListeners();

            // Setup real-time subscriptions
            setupRealtimeSubscriptions();

            if (isIOS()) {
                document.body.classList.add('ios');
            }
        });

        // Test Supabase connection
        async function testSupabaseConnection() {
            try {
                // First check if tables exist, if not suggest creating them
                const { data, error } = await supabase
                    .from('food_log')
                    .select('count')
                    .limit(1);

                if (error) {
                    if (error.code === 'PGRST116') {
                        // Table doesn't exist
                        isConnected = false;
                        updateConnectionStatus('error');
                        showToast('error', 'Tables Missing', 'Please create the required database tables');
                        console.error('‚ùå Database tables not found. Please run the SQL schema.');
                        return;
                    } else {
                        throw error;
                    }
                }

                isConnected = true;
                updateConnectionStatus('connected');
                console.log('‚úÖ Supabase connected successfully');
                showToast('success', 'Connected', 'Database connection successful');
            } catch (error) {
                isConnected = false;
                updateConnectionStatus('error');
                console.error('‚ùå Supabase connection failed:', error);
                showToast('error', 'Connection Failed', error.message || 'Check your Supabase configuration');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Form submission
            const form = $('nutritionForm');
            if (form) {
                form.addEventListener('submit', handleFormSubmit);
            }

            // Input change handlers with debouncing
            ['calories', 'protein', 'carbs', 'fat'].forEach(field => {
                const element = $(field);
                if (element) {
                    element.addEventListener('input', debounce(() => {
                        updateMacroCalculation();
                        triggerHaptic();

                        // Clear favorite indicator if user manually changes values
                        if (currentFavorite) {
                            hideFavoriteIndicator();
                        }
                    }, 300));
                }
            });

            // Setup pull to refresh
            setupPullToRefresh();

            // Button haptic feedback
            document.addEventListener('click', (e) => {
                if (e.target.matches('button, .btn, [onclick]')) {
                    triggerHaptic();
                }
            });
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Haptic feedback
        function triggerHaptic() {
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        }

        // Setup pull to refresh
        function setupPullToRefresh() {
            let startY = 0;
            let pullDistance = 0;
            const container = document.querySelector('.container');
            const pullIcon = $('pullToRefresh');

            if (!container || !pullIcon) return;

            container.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
            });

            container.addEventListener('touchmove', (e) => {
                if (window.scrollY === 0) {
                    pullDistance = e.touches[0].clientY - startY;
                    if (pullDistance > 0 && pullDistance < 80) {
                        pullIcon.style.top = (pullDistance - 40) + 'px';
                        pullIcon.style.opacity = pullDistance / 80;
                    }
                }
            });

            container.addEventListener('touchend', () => {
                if (pullDistance > 50) {
                    refreshData();
                }
                pullIcon.style.top = '-40px';
                pullIcon.style.opacity = '0';
                pullDistance = 0;
            });
        }

        // Refresh data function
        async function refreshData() {
            showToast('info', 'Refreshing...', 'Reloading data from database');
            await Promise.all([
                loadTodaysTotals(),
                loadTodaysEntries(),
                loadFavorites()
            ]);
            showToast('success', 'Refreshed', 'Data updated from database');
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();

            if (!validateForm()) return;

            const formData = getFormData();
            const submitBtn = $('submitBtn');

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                // Insert into Supabase
                const { data, error } = await supabase
                    .from('food_log')
                    .insert([formData])
                    .select()
                    .single();

                if (error) throw error;

                lastEntry = data;

                // Show success animation
                showSuccessAnimation();

                // Reload data (real-time will also update)
                await loadTodaysTotals();
                await loadTodaysEntries();

                // Show action buttons
                showPostSubmitButtons();

                showToast('success', 'Entry Logged!', 'Saved to database');

                // Clear form
                setTimeout(() => {
                    $('nutritionForm').reset();
                    $('macroCalc').style.display = 'none';
                }, 1500);

            } catch (error) {
                console.error('Save error:', error);
                showToast('error', 'Save Failed', error.message);
            } finally {
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Log Entry';
                    submitBtn.classList.remove('success');
                }, 2000);
            }
        }

        // Get form data
        function getFormData() {
            const data = {
                calories: parseFloat($('calories').value) || 0,
                protein: parseFloat($('protein').value) || 0,
                carbs: parseFloat($('carbs').value) || 0,
                fat: parseFloat($('fat').value) || 0,
                meal_type: $('mealType').value,
                description: $('description').value.trim(),
                source: currentFavorite ? 'Favorite' : 'Manual',
                favorite_name: currentFavorite ? currentFavorite.name : null,
                client_id: getClientId(),
                date: new Date().toISOString().split('T')[0]
            };
            return data;
        }

        // Get or create client ID
        function getClientId() {
            let clientId = localStorage.getItem('clientId');
            if (!clientId) {
                clientId = 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('clientId', clientId);
            }
            return clientId;
        }

        // Validate form
        function validateForm() {
            const calories = parseFloat($('calories').value) || 0;
            const protein = parseFloat($('protein').value) || 0;
            const carbs = parseFloat($('carbs').value) || 0;
            const fat = parseFloat($('fat').value) || 0;

            if (calories === 0 && protein === 0 && carbs === 0 && fat === 0) {
                showToast('error', 'Empty Entry', 'Please enter at least one value');
                return false;
            }

            if (calories < 0 || calories > 5000) {
                showToast('error', 'Invalid Calories', 'Must be between 0-5000');
                return false;
            }

            return true;
        }

        // Load today's totals
        async function loadTodaysTotals() {
            try {
                const today = new Date().toISOString().split('T')[0];

                const { data, error } = await supabase
                    .from('food_log')
                    .select('calories, protein, carbs, fat')
                    .eq('date', today);

                if (error) throw error;

                // Calculate totals
                dailyTotals = {
                    calories: 0,
                    protein: 0,
                    carbs: 0,
                    fat: 0
                };

                data.forEach(entry => {
                    dailyTotals.calories += parseFloat(entry.calories) || 0;
                    dailyTotals.protein += parseFloat(entry.protein) || 0;
                    dailyTotals.carbs += parseFloat(entry.carbs) || 0;
                    dailyTotals.fat += parseFloat(entry.fat) || 0;
                });

                updateTotalsDisplay();
            } catch (error) {
                console.error('Error loading totals:', error);
            }
        }

        // Load today's entries
        async function loadTodaysEntries() {
            try {
                const today = new Date().toISOString().split('T')[0];

                const { data, error } = await supabase
                    .from('food_log')
                    .select('*')
                    .eq('date', today)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                todaysEntries = data;
                updateHistoryDisplay();
            } catch (error) {
                console.error('Error loading entries:', error);
            }
        }

        // Load favorites
        async function loadFavorites() {
            try {
                const { data, error } = await supabase
                    .from('favorites')
                    .select('*')
                    .order('use_count', { ascending: false });

                if (error) throw error;

                favorites = data;
                displayFavorites();
            } catch (error) {
                console.error('Error loading favorites:', error);
            }
        }

        // Save as favorite
        async function saveAsFavorite() {
            const calories = parseFloat($('calories').value) || 0;
            const protein = parseFloat($('protein').value) || 0;
            const carbs = parseFloat($('carbs').value) || 0;
            const fat = parseFloat($('fat').value) || 0;
            const description = $('description').value.trim();

            if (!calories && !protein && !carbs && !fat) {
                showToast('error', 'No Data', 'Enter nutrition values first');
                return;
            }

            const name = prompt('Name this favorite:', description || 'My Favorite');
            if (!name) return;

            try {
                const { data, error } = await supabase
                    .from('favorites')
                    .insert([{
                        name: name,
                        calories: calories,
                        protein: protein,
                        carbs: carbs,
                        fat: fat,
                        meal_type: $('mealType').value,
                        description: description,
                        category: $('mealType').value
                    }])
                    .select()
                    .single();

                if (error) throw error;

                await loadFavorites();
                showToast('success', 'Favorite Saved', `"${name}" added to favorites`);
            } catch (error) {
                console.error('Error saving favorite:', error);
                showToast('error', 'Save Failed', error.message);
            }
        }

        // Load favorite into form
        async function loadFavorite(favoriteId) {
            const favorite = favorites.find(f => f.id == favoriteId);
            if (!favorite) return;

            // Load values into form
            $('calories').value = favorite.calories;
            $('protein').value = favorite.protein;
            $('carbs').value = favorite.carbs;
            $('fat').value = favorite.fat;
            $('mealType').value = favorite.meal_type;
            $('description').value = favorite.description || '';

            currentFavorite = favorite;
            updateMacroCalculation();

            // Show favorite indicator
            showFavoriteIndicator(favorite.name);

            // Update use count
            await supabase
                .from('favorites')
                .update({
                    use_count: (favorite.use_count || 0) + 1,
                    last_used: new Date().toISOString()
                })
                .eq('id', favorite.id);

            showToast('success', 'Loaded', `"${favorite.name}" loaded into form`);
        }

        // Show favorite indicator
        function showFavoriteIndicator(favoriteName) {
            const indicator = $('favoriteIndicator');
            indicator.innerHTML = `‚≠ê Loaded: "${favoriteName}"`;
            indicator.classList.add('show');

            // Clear existing timeout
            if (favoriteIndicatorTimeout) {
                clearTimeout(favoriteIndicatorTimeout);
            }

            // Auto-hide after 10 seconds if not submitted
            favoriteIndicatorTimeout = setTimeout(() => {
                hideFavoriteIndicator();
            }, 10000);
        }

        // Hide favorite indicator
        function hideFavoriteIndicator() {
            const indicator = $('favoriteIndicator');
            indicator.classList.remove('show');
            currentFavorite = null;

            if (favoriteIndicatorTimeout) {
                clearTimeout(favoriteIndicatorTimeout);
                favoriteIndicatorTimeout = null;
            }
        }

        // Delete favorite
        async function deleteFavorite(favoriteId) {
            if (!confirm('Delete this favorite?')) return;

            try {
                const { error } = await supabase
                    .from('favorites')
                    .delete()
                    .eq('id', favoriteId);

                if (error) throw error;

                await loadFavorites();
                showToast('info', 'Deleted', 'Favorite removed');
            } catch (error) {
                console.error('Error deleting favorite:', error);
                showToast('error', 'Delete Failed', error.message);
            }
        }

        // Display favorites
        function displayFavorites() {
            const grid = $('favoritesGrid');
            grid.innerHTML = '';

            // Get filter values
            const filterValue = $('favoritesFilter')?.value || 'all';
            const searchValue = $('favoritesSearch')?.value?.toLowerCase() || '';

            // Filter favorites
            const filteredFavorites = favorites.filter(fav => {
                const matchesCategory = filterValue === 'all' || fav.category === filterValue;
                const matchesSearch = !searchValue ||
                    fav.name.toLowerCase().includes(searchValue) ||
                    (fav.description && fav.description.toLowerCase().includes(searchValue));
                return matchesCategory && matchesSearch;
            });

            if (filteredFavorites.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #a0a0a0; padding: 20px;">No favorites found. Save entries to build your collection!</div>';
                return;
            }

            // Sort by use count and last used
            filteredFavorites.sort((a, b) => {
                if (a.last_used && b.last_used) {
                    return new Date(b.last_used) - new Date(a.last_used);
                }
                return (b.use_count || 0) - (a.use_count || 0);
            });

            filteredFavorites.forEach(fav => {
                const btn = document.createElement('button');
                btn.className = 'favorite-btn';
                btn.innerHTML = `
                    <div class="favorite-name">${fav.name}</div>
                    <div class="favorite-macros">${Math.round(fav.calories)}cal ‚Ä¢ ${Math.round(fav.protein)}p ‚Ä¢ ${Math.round(fav.carbs)}c ‚Ä¢ ${Math.round(fav.fat)}f</div>
                    <button class="delete-favorite" onclick="event.stopPropagation(); deleteFavorite(${fav.id})">√ó</button>
                `;
                btn.onclick = () => loadFavorite(fav.id);
                grid.appendChild(btn);
            });
        }

        // Delete entry
        async function deleteEntry(entryId) {
            if (!confirm('Delete this entry?')) return;

            try {
                const { error } = await supabase
                    .from('food_log')
                    .delete()
                    .eq('id', entryId);

                if (error) throw error;

                await loadTodaysTotals();
                await loadTodaysEntries();
                showToast('info', 'Deleted', 'Entry removed');
            } catch (error) {
                console.error('Error deleting entry:', error);
                showToast('error', 'Delete Failed', error.message);
            }
        }

        // Reload entry into form
        function reloadEntry(entryId) {
            const entry = todaysEntries.find(e => e.id == entryId);
            if (!entry) return;

            $('calories').value = entry.calories;
            $('protein').value = entry.protein;
            $('carbs').value = entry.carbs;
            $('fat').value = entry.fat;
            $('mealType').value = entry.meal_type;
            $('description').value = entry.description || '';

            updateMacroCalculation();
            $('nutritionForm').scrollIntoView({ behavior: 'smooth' });
            showToast('info', 'Loaded', 'Previous entry loaded into form');
        }

        // Undo last entry
        async function undoLastEntry() {
            if (!lastEntry) {
                showToast('error', 'Nothing to Undo', 'No recent entry found');
                return;
            }

            if (confirm('Undo last entry?')) {
                await deleteEntry(lastEntry.id);
                lastEntry = null;
                $('undoBtn').classList.remove('show');
            }
        }

        // Update totals display
        function updateTotalsDisplay() {
            $('totalCalories').textContent = Math.round(dailyTotals.calories);
            $('totalProtein').textContent = Math.round(dailyTotals.protein) + 'g';
            $('totalCarbs').textContent = Math.round(dailyTotals.carbs) + 'g';
            $('totalFat').textContent = Math.round(dailyTotals.fat) + 'g';

            // Update progress bars
            updateProgressBar('caloriesProgress', dailyTotals.calories, DAILY_GOALS.calories);
            updateProgressBar('proteinProgress', dailyTotals.protein, DAILY_GOALS.protein);
            updateProgressBar('carbsProgress', dailyTotals.carbs, DAILY_GOALS.carbs);
            updateProgressBar('fatProgress', dailyTotals.fat, DAILY_GOALS.fat);
        }

        // Update progress bar
        function updateProgressBar(elementId, current, goal) {
            const percentage = Math.min((current / goal) * 100, 100);
            $(elementId).style.width = percentage + '%';
        }

        // Update history display
        function updateHistoryDisplay() {
            const container = $('historyContainer');
            container.innerHTML = '';

            if (!todaysEntries.length) {
                container.innerHTML = '<p style="text-align: center; color: #a0a0a0; padding: 20px;">No entries today</p>';
                return;
            }

            todaysEntries.forEach(entry => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-header">
                        <div>
                            <strong>${entry.meal_type}</strong>
                            ${entry.description ? `<div style="font-size: 11px; color: #a0a0a0; margin-top: 2px;">${entry.description}</div>` : ''}
                            ${entry.source === 'Favorite' ? `<div style="font-size: 10px; color: #667eea;">‚≠ê ${entry.favorite_name}</div>` : ''}
                        </div>
                        <span class="history-time">${formatTime(entry.created_at)}</span>
                    </div>
                    <div class="history-details">
                        <div class="history-macro">
                            <div class="history-macro-value">${Math.round(entry.calories)}</div>
                            <div class="history-macro-label">Cal</div>
                        </div>
                        <div class="history-macro">
                            <div class="history-macro-value">${Math.round(entry.protein)}g</div>
                            <div class="history-macro-label">Pro</div>
                        </div>
                        <div class="history-macro">
                            <div class="history-macro-value">${Math.round(entry.carbs)}g</div>
                            <div class="history-macro-label">Carbs</div>
                        </div>
                        <div class="history-macro">
                            <div class="history-macro-value">${Math.round(entry.fat)}g</div>
                            <div class="history-macro-label">Fat</div>
                        </div>
                    </div>
                    <button class="history-delete" onclick="deleteEntry(${entry.id})">Delete</button>
                `;

                div.addEventListener('click', (e) => {
                    if (!e.target.closest('.history-delete')) {
                        reloadEntry(entry.id);
                    }
                });

                container.appendChild(div);
            });
        }

        // Setup real-time subscriptions
        function setupRealtimeSubscriptions() {
            // Subscribe to changes in food_log table
            supabase
                .channel('food_log_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'food_log' },
                    async (payload) => {
                        console.log('Real-time update:', payload);

                        // Reload data when changes occur
                        await loadTodaysTotals();
                        await loadTodaysEntries();
                    }
                )
                .subscribe();

            // Subscribe to favorites changes
            supabase
                .channel('favorites_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'favorites' },
                    async (payload) => {
                        await loadFavorites();
                    }
                )
                .subscribe();
        }

        // Update macro calculation
        function updateMacroCalculation() {
            const protein = parseFloat($('protein').value) || 0;
            const carbs = parseFloat($('carbs').value) || 0;
            const fat = parseFloat($('fat').value) || 0;
            const calories = parseFloat($('calories').value) || 0;

            const calculatedCals = (protein * 4) + (carbs * 4) + (fat * 9);
            const macroCalc = $('macroCalc');

            if (protein || carbs || fat) {
                macroCalc.style.display = 'block';

                if (calories === 0) {
                    macroCalc.innerHTML = `Calculated: ${Math.round(calculatedCals)} calories`;
                    macroCalc.className = 'macro-calc';

                    // Auto-fill calories if empty
                    if (calculatedCals > 0) {
                        $('calories').value = Math.round(calculatedCals);
                    }
                } else {
                    const diff = Math.abs(calories - calculatedCals);
                    const threshold = calories * 0.2; // 20% threshold

                    if (diff > threshold) {
                        macroCalc.innerHTML = `‚ö†Ô∏è Macros suggest ${Math.round(calculatedCals)} calories`;
                        macroCalc.className = 'macro-calc macro-warning';
                    } else {
                        macroCalc.innerHTML = `‚úì Macros match calories`;
                        macroCalc.className = 'macro-calc';
                    }
                }
            } else {
                macroCalc.style.display = 'none';
            }

            // Clear favorite indicator if user manually changes values
            if (currentFavorite) {
                hideFavoriteIndicator();
            }
        }

        // Apple Health integration
        function logToAppleHealth() {
            if (!lastEntry) {
                showToast('error', 'No Entry', 'Submit an entry first');
                return;
            }

            const jsonData = JSON.stringify({
                calories: lastEntry.calories,
                protein: lastEntry.protein,
                carbs: lastEntry.carbs,
                fat: lastEntry.fat
            });

            const url = `shortcuts://x-callback-url/run-shortcut?name=Log%20Nutrition&input=text&text=${encodeURIComponent(jsonData)}`;
            window.location.href = url;
        }

        // Helper functions
        function isIOS() {
            return /iPhone|iPad|iPod/i.test(navigator.userAgent) ||
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function updateDateDisplay() {
            const now = new Date();
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            $('dateDisplay').textContent = now.toLocaleDateString('en-US', options);
        }

        function showSuccessAnimation() {
            const btn = $('submitBtn');
            btn.classList.add('success');
            btn.innerHTML = '<span class="success-checkmark">‚úì</span>';
            triggerHaptic(50);

            setTimeout(() => {
                btn.innerHTML = 'Entry Logged!';
            }, 500);
        }

        function showPostSubmitButtons() {
            if (isIOS()) {
                $('appleHealthOptions').classList.add('show');
                setTimeout(() => {
                    $('appleHealthOptions').classList.remove('show');
                }, 10000);
            }

            $('undoBtn').classList.add('show');
            setTimeout(() => {
                $('undoBtn').classList.remove('show');
            }, 8000);

            // Clear favorite indicator after submission
            if (currentFavorite) {
                setTimeout(() => {
                    hideFavoriteIndicator();
                }, 2000);
            }
        }

        function updateConnectionStatus(status) {
            const dot = $('statusDot');
            const text = $('statusText');

            switch(status) {
                case 'connected':
                    dot.className = 'status-dot connected';
                    text.textContent = 'Connected';
                    break;
                case 'error':
                    dot.className = 'status-dot error';
                    text.textContent = 'Connection Error';
                    break;
                default:
                    dot.className = 'status-dot';
                    text.textContent = 'Connecting...';
            }
        }

        function showToast(type, title, message, duration = 3000) {
            // Limit to 2 toasts
            if (toastCount >= 2) {
                return;
            }

            toastCount++;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '‚úì',
                error: '‚úó',
                info: '‚Ñπ',
                warning: '‚ö†'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <div>
                    <div class="toast-title">${title}</div>
                    <div style="font-size: 11px; color: #a0a0a0;">${message}</div>
                </div>
            `;

            $('toastContainer').appendChild(toast);

            // Trigger show animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.2s ease reverse';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                    toastCount--;
                }, 200);
            }, duration);
        }

        function stepValue(field, amount) {
            const input = $(field);
            const current = parseFloat(input.value) || 0;
            input.value = Math.max(0, current + amount);
            updateMacroCalculation();
        }

        // Test panel functions
        window.toggleTestPanel = function() {
            $('testPanel').classList.toggle('show');
        }

        window.testConnection = async function() {
            showToast('info', 'Testing...', 'Checking database connection');
            await testSupabaseConnection();
        }

        window.exportData = async function() {
            try {
                const { data, error } = await supabase
                    .from('food_log')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `nutrition-export-${new Date().toISOString().split('T')[0]}.json`;
                a.click();

                showToast('success', 'Exported', `${data.length} entries exported`);
            } catch (error) {
                showToast('error', 'Export Failed', error.message);
            }
        }

        window.clearAllData = async function() {
            if (!confirm('Delete ALL data? This cannot be undone!')) return;
            if (!confirm('Are you absolutely sure? All entries and favorites will be deleted!')) return;

            try {
                await supabase.from('food_log').delete().neq('id', 0);
                await supabase.from('favorites').delete().neq('id', 0);

                await loadTodaysTotals();
                await loadTodaysEntries();
                await loadFavorites();

                showToast('info', 'Cleared', 'All data deleted');
            } catch (error) {
                showToast('error', 'Clear Failed', error.message);
            }
        }

        window.createTables = async function() {
            const sql = `
                -- Create food_log table
                CREATE TABLE IF NOT EXISTS food_log (
                    id BIGSERIAL PRIMARY KEY,
                    calories NUMERIC NOT NULL DEFAULT 0,
                    protein NUMERIC NOT NULL DEFAULT 0,
                    carbs NUMERIC NOT NULL DEFAULT 0,
                    fat NUMERIC NOT NULL DEFAULT 0,
                    meal_type TEXT NOT NULL,
                    description TEXT,
                    source TEXT DEFAULT 'Manual',
                    favorite_name TEXT,
                    client_id TEXT,
                    date DATE NOT NULL DEFAULT CURRENT_DATE,
                    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
                );

                -- Create favorites table
                CREATE TABLE IF NOT EXISTS favorites (
                    id BIGSERIAL PRIMARY KEY,
                    name TEXT NOT NULL,
                    calories NUMERIC NOT NULL DEFAULT 0,
                    protein NUMERIC NOT NULL DEFAULT 0,
                    carbs NUMERIC NOT NULL DEFAULT 0,
                    fat NUMERIC NOT NULL DEFAULT 0,
                    meal_type TEXT NOT NULL,
                    description TEXT,
                    category TEXT,
                    use_count INTEGER DEFAULT 0,
                    last_used TIMESTAMPTZ,
                    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
                );

                -- Enable RLS
                ALTER TABLE food_log ENABLE ROW LEVEL SECURITY;
                ALTER TABLE favorites ENABLE ROW LEVEL SECURITY;

                -- Create policies
                CREATE POLICY "Allow all operations on food_log" ON food_log FOR ALL USING (true);
                CREATE POLICY "Allow all operations on favorites" ON favorites FOR ALL USING (true);
            `;

            showToast('info', 'Creating Tables', 'Please run this SQL in your Supabase dashboard:');

            // Copy to clipboard
            if (navigator.clipboard) {
                await navigator.clipboard.writeText(sql);
                showToast('success', 'SQL Copied', 'Paste this in your Supabase SQL editor and run it');
            } else {
                console.log('SQL to create tables:', sql);
                showToast('info', 'SQL Available', 'Check browser console for SQL commands');
            }
        }

        window.migrateFromLocalStorage = async function() {
            try {
                // Get old data from localStorage
                const oldEntries = JSON.parse(localStorage.getItem('todaysEntries') || '[]');
                const oldFavorites = JSON.parse(localStorage.getItem('favorites') || '[]');

                let migrated = 0;

                // Migrate entries
                for (const entry of oldEntries) {
                    const { error } = await supabase
                        .from('food_log')
                        .insert([{
                            calories: entry.calories,
                            protein: entry.protein,
                            carbs: entry.carbs,
                            fat: entry.fat,
                            meal_type: entry.mealType,
                            description: entry.description,
                            source: entry.source || 'Manual',
                            favorite_name: entry.favoriteName,
                            client_id: entry.id
                        }]);

                    if (!error) migrated++;
                }

                // Migrate favorites
                for (const fav of oldFavorites) {
                    await supabase
                        .from('favorites')
                        .insert([{
                            name: fav.name,
                            calories: fav.calories,
                            protein: fav.protein,
                            carbs: fav.carbs,
                            fat: fav.fat,
                            meal_type: fav.mealType,
                            description: fav.description,
                            category: fav.category || fav.mealType
                        }]);
                }

                await loadTodaysTotals();
                await loadTodaysEntries();
                await loadFavorites();

                showToast('success', 'Migrated', `${migrated} entries imported from old system`);
            } catch (error) {
                showToast('error', 'Migration Failed', error.message);
            }
        }

        // Filter favorites function
        window.filterFavorites = function() {
            displayFavorites();
        }

        // Make functions global for onclick handlers
        window.stepValue = stepValue;
        window.logToAppleHealth = logToAppleHealth;
        window.saveAsFavorite = saveAsFavorite;
        window.loadFavorite = loadFavorite;
        window.deleteFavorite = deleteFavorite;
        window.deleteEntry = deleteEntry;
        window.reloadEntry = reloadEntry;
        window.undoLastEntry = undoLastEntry;
    </script>
</body>
</html>
